<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Code Maker â€” PHP Enabled</title>

<!-- CodeMirror CSS & Theme -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css">

<style>
  :root{--bg:#0d1117;--panel:#161b22;--muted:#c9d1d9;}
  body { margin:0; font-family: Arial, monospace; display:flex; height:100vh; background:var(--bg); color:var(--muted); }
  .sidebar { width:240px; background:var(--panel); padding:12px; display:flex; flex-direction:column; gap:8px; }
  .sidebar h2{margin:0;font-size:16px}
  .project-item{padding:8px;border-radius:6px;background:#21252b;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .project-item:hover{background:#2b3138}
  .editor-wrap{flex:1; display:flex; flex-direction:column; min-width:0}
  .tabs{display:flex; background:var(--panel); border-bottom:1px solid #222;}
  .tab{flex:1;padding:10px;text-align:center;cursor:pointer}
  .tab.active{border-bottom:3px solid #58a6ff}
  .editor{flex:1; display:none; position:relative; min-height:0}
  .editor.active{display:block}
  .buttons{display:flex; gap:8px; padding:8px; background:var(--panel)}
  button{background:#238636;color:white;border:none;padding:7px 12px;border-radius:6px;cursor:pointer}
  button.warn{background:#bf4b4b}
  input[type="text"]{padding:8px;border-radius:6px;border:1px solid #2a2f36;background:#0e1114;color:var(--muted);width:100%}
  .CodeMirror{height:100%;font-size:14px}
  #htmlErrors{position:absolute;bottom:0;left:0;right:0;background:#1f242b;color:#ff6c6b;padding:6px 8px;font-size:12px;max-height:120px;overflow:auto}
  .preview-container{display:flex;flex-direction:column;height:40%;transition:height .25s ease}
  .preview-container.collapsed{height:0}
  iframe{flex:1;border:none;background:white}
  .note{font-size:12px;color:#9aa3b2;margin-top:6px}
  .small-btn{background:#0b74d1;padding:6px 8px;border-radius:6px}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Projects</h2>
  <div id="projectList" style="overflow:auto;max-height:60vh"></div>
  <input id="projectName" type="text" placeholder="Project name (e.g. my-site)">
  <div style="display:flex;gap:8px;">
    <button onclick="saveProject()">ðŸ’¾ Save</button>
    <button onclick="exportZip()">ðŸ“¦ Export ZIP</button>
  </div>
  <button class="warn" onclick="clearAll()">ðŸ—‘ Clear All Projects</button>
  <div class="note">
    <strong>Note:</strong> PHP cannot run inside the browser preview. To execute PHP you must extract the ZIP and run a PHP server:<br>
    <code>php -S localhost:8000</code>
  </div>
</div>

<div class="editor-wrap">
  <div class="tabs">
    <div class="tab active" data-tab="html">HTML</div>
    <div class="tab" data-tab="css">CSS</div>
    <div class="tab" data-tab="js">JS</div>
    <div class="tab" data-tab="php">PHP</div>
  </div>

  <div id="html" class="editor active">
    <textarea id="htmlCode"><!â€” Type HTML here â€”></textarea>
    <div id="htmlErrors"></div>
  </div>

  <div id="css" class="editor">
    <textarea id="cssCode">/* Type CSS here */</textarea>
  </div>

  <div id="js" class="editor">
    <textarea id="jsCode">// Type JS here</textarea>
  </div>

  <div id="php" class="editor">
    <textarea id="phpCode"><?php
// Type PHP code here
?></textarea>
  </div>

  <div class="buttons">
    <button onclick="runCode()">â–¶ Run (Preview)</button>
    <button onclick="togglePreview()">ðŸ–¥ Toggle Preview</button>
    <button onclick="openPreviewTab()">ðŸ”— Open Preview (new tab)</button>
    <button class="small-btn" onclick="openPhpSource()">ðŸ“„ Open PHP (source)</button>
  </div>

  <div class="preview-container" id="previewContainer">
    <iframe id="output"></iframe>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>

<!-- JSZip for export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
/* ----- Tabs ----- */
const tabs = document.querySelectorAll('.tab');
const editorsDiv = document.querySelectorAll('.editor');
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    editorsDiv.forEach(e=>e.classList.remove('active'));
    document.getElementById(tab.dataset.tab).classList.add('active');
    refreshEditors();
  });
});

/* ----- Initialize CodeMirror editors ----- */
const commonOpts = { theme:'material-darker', lineNumbers:true, matchBrackets:true, indentUnit:2, tabSize:2 };
const htmlEditor = CodeMirror.fromTextArea(document.getElementById('htmlCode'), Object.assign({}, commonOpts, { mode:'xml', autoCloseTags:true }));
const cssEditor  = CodeMirror.fromTextArea(document.getElementById('cssCode'),  Object.assign({}, commonOpts, { mode:'css' }));
const jsEditor   = CodeMirror.fromTextArea(document.getElementById('jsCode'),   Object.assign({}, commonOpts, { mode:'javascript' }));
const phpEditor  = CodeMirror.fromTextArea(document.getElementById('phpCode'),  Object.assign({}, commonOpts, { mode:'application/x-httpd-php' }));

function refreshEditors(){
  setTimeout(()=>{ htmlEditor.refresh(); cssEditor.refresh(); jsEditor.refresh(); phpEditor.refresh(); }, 60);
}

/* ----- HTML nesting validation (simple stack-based) ----- */
function validateHTML(value){
  const tagPattern = /<\/?([a-zA-Z][a-zA-Z0-9:-]*)\b[^>]*>/g;
  const selfClosing = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
  const stack = [];
  const errors = [];
  let match;
  while((match = tagPattern.exec(value)) !== null){
    const raw = match[0];
    const tag = match[1].toLowerCase();
    if(raw.startsWith('</')){
      if(stack.length === 0 || stack[stack.length-1] !== tag){
        errors.push(`Mismatched closing tag </${tag}> at index ${match.index}`);
      } else {
        stack.pop();
      }
    } else {
      // opening tag
      if(!raw.endsWith('/>') && !selfClosing.has(tag)){
        stack.push(tag);
      }
    }
  }
  // remaining unclosed tags
  stack.reverse().forEach(t=> errors.push(`Unclosed tag <${t}>`));
  return errors;
}

htmlEditor.on('change', ()=>{
  const v = htmlEditor.getValue();
  const errors = validateHTML(v);
  document.getElementById('htmlErrors').innerHTML = errors.length ? errors.join('<br>') : '';
});

/* ----- Run / Preview ----- */
function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function runCode(){
  const html = htmlEditor.getValue();
  const css = '<style>' + cssEditor.getValue() + '</style>';
  const js  = '<script>' + jsEditor.getValue() + '<\/script>';
  const php = phpEditor.getValue().trim();

  // If there is PHP code, we cannot execute it in the browser.
  let outContent;
  if(php){
    // Show HTML/CSS/JS result and append PHP source as readable block + warning
    outContent = `
      <!-- PHP code present. Browser cannot execute PHP. Extract project and run with a PHP server. -->
      <div style="padding:12px;background:#ffe8e8;color:#6b0b0b;font-family:Arial, sans-serif">
        <strong>PHP detected:</strong> This preview shows HTML/CSS/JS only. To execute PHP, export the project and run a local PHP server (see note in sidebar).
      </div>
      ${html}
      ${css}
      ${js}
      <hr>
      <pre style="white-space:pre-wrap;padding:12px;background:#f6f8fa;border-radius:6px;">${escapeHtml(php)}</pre>
    `;
  } else {
    outContent = html + css + js;
  }

  const iframe = document.getElementById('output');
  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(outContent);
  doc.close();
}

/* ----- Preview controls ----- */
function togglePreview(){
  document.getElementById('previewContainer').classList.toggle('collapsed');
}

function openPreviewTab(){
  const html = htmlEditor.getValue();
  const css = '<style>' + cssEditor.getValue() + '</style>';
  const js  = '<script>' + jsEditor.getValue() + '<\/script>';
  const php = phpEditor.getValue().trim();

  let content;
  if(php){
    content = `<!-- PHP present: browser cannot execute. To run, extract and serve with PHP. -->\n${html}\n${css}\n${js}\n\n<pre>${escapeHtml(php)}</pre>`;
  } else {
    content = html + css + js;
  }
  const newTab = window.open();
  newTab.document.open();
  newTab.document.write(content);
  newTab.document.close();
}

/* Open PHP source as raw text in new tab (helpful) */
function openPhpSource(){
  const php = phpEditor.getValue();
  const blob = new Blob([php], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}

/* ----- Projects: save/load/delete ----- */
function saveProject(){
  const name = document.getElementById('projectName').value.trim();
  if(!name){ alert('Enter a project name'); return; }
  const project = {
    html: htmlEditor.getValue(),
    css: cssEditor.getValue(),
    js: jsEditor.getValue(),
    php: phpEditor.getValue()
  };
  localStorage.setItem('project_' + name, JSON.stringify(project));
  loadProjects();
  alert('Saved: ' + name);
}

function loadProjects(){
  const list = document.getElementById('projectList');
  list.innerHTML = '';
  Object.keys(localStorage).forEach(k=>{
    if(!k.startsWith('project_')) return;
    const name = k.replace('project_','');
    const div = document.createElement('div');
    div.className = 'project-item';
    const left = document.createElement('span');
    left.textContent = name;
    left.style.flex='1';
    left.onclick = ()=> openProject(name);
    div.appendChild(left);

    const del = document.createElement('button');
    del.textContent = 'ðŸ—‘';
    del.style.background = '#bf4b4b';
    del.style.border = 'none';
    del.style.color = 'white';
    del.style.borderRadius = '6px';
    del.onclick = (e)=>{ e.stopPropagation(); if(confirm('Delete '+name+'?')){ localStorage.removeItem('project_'+name); loadProjects(); }};
    div.appendChild(del);

    list.appendChild(div);
  });
}

function openProject(name){
  const data = localStorage.getItem('project_' + name);
  if(!data) return;
  const p = JSON.parse(data);
  document.getElementById('projectName').value = name;
  htmlEditor.setValue(p.html || '');
  cssEditor.setValue(p.css || '');
  jsEditor.setValue(p.js || '');
  phpEditor.setValue(p.php || '');
  refreshEditors();
  runCode();
}

function clearAll(){
  if(!confirm('Delete all saved projects?')) return;
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith('project_')) localStorage.removeItem(k); });
  loadProjects();
}

/* ----- Export ZIP (JSZip) ----- */
async function exportZip(){
  const name = document.getElementById('projectName').value.trim() || 'project';
  const zip = new JSZip();

  // create index.php (if php exists) otherwise index.html
  const phpContent = phpEditor.getValue().trim();
  const htmlContent = htmlEditor.getValue();
  const cssContent = cssEditor.getValue();
  const jsContent = jsEditor.getValue();

  if(phpContent){
    // build a simple index.php combining php + html (php at top)
    const indexPhp = `<?php\n${phpContent}\n?>\n${htmlContent}\n<link rel="stylesheet" href="style.css">\n<script src="script.js"></script>`;
    zip.file('index.php', indexPhp);
  } else {
    const indexHtml = `${htmlContent}\n<link rel="stylesheet" href="style.css">\n<script src="script.js"></script>`;
    zip.file('index.html', indexHtml);
  }

  zip.file('style.css', cssContent || '/* styles */');
  zip.file('script.js', jsContent || '// scripts');

  const blob = await zip.generateAsync({type:'blob'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name + '.zip';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ----- Initialize ----- */
loadProjects();
refreshEditors();
runCode();

</script>
</body>
</html>
